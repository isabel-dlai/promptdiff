<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Response Diff Tool</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <style>
            .unified-scroll-container {
                max-height: 600px;
                overflow-y: auto;
                border: 1px solid #dee2e6;
                background-color: #f8f9fa;
                margin-bottom: 2rem;
            }
            .response-wrapper {
                display: flex;
                min-height: 100%;
            }
            .response-column {
                flex: 1;
                min-width: 0;
                border-right: 1px solid #dee2e6;
            }
            .response-column:last-child {
                border-right: none;
            }
            .sticky-header {
                position: sticky;
                top: 0;
                background-color: #ffffff;
                padding: 12px 15px;
                margin: 0;
                border-bottom: 2px solid #dee2e6;
                z-index: 10;
                font-weight: 600;
            }
            .response-content {
                padding: 15px;
                line-height: 1.6;
            }
            .response-content p {
                margin-bottom: 0.75rem;
                line-height: 1.5;
            }
            .response-content p:last-child {
                margin-bottom: 0;
            }
            .response-content ul,
            .response-content ol {
                margin-bottom: 0.75rem;
                padding-left: 1.5rem;
            }
            .response-content li {
                margin-bottom: 0.25rem;
            }
            .response-content h1,
            .response-content h2,
            .response-content h3,
            .response-content h4,
            .response-content h5,
            .response-content h6 {
                margin-top: 1rem;
                margin-bottom: 0.5rem;
            }
            .highlight-shared {
                background-color: rgba(255, 235, 59, 0.3);
                padding: 2px 4px;
                border-radius: 3px;
            }
            .diff-container {
                max-height: 600px;
                overflow-y: auto;
                border: 1px solid #dee2e6;
                padding: 15px;
                background-color: #f8f9fa;
            }
            .custom-diff {
                font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
                font-size: 14px;
                line-height: 1.5;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            .diff-equal {
                background-color: #ffffff;
                padding: 8px 12px;
                margin: 2px 0;
                border-left: 4px solid #28a745;
                border-radius: 4px;
            }
            .diff-delete {
                background-color: #f8d7da;
                padding: 8px 12px;
                margin: 2px 0;
                border-left: 4px solid #dc3545;
                border-radius: 4px;
            }
            .diff-insert {
                background-color: #d4edda;
                padding: 8px 12px;
                margin: 2px 0;
                border-left: 4px solid #28a745;
                border-radius: 4px;
            }
            .diff-changed {
                background-color: #fff3cd;
                padding: 8px 12px;
                margin: 2px 0;
                border-left: 4px solid #ffc107;
                border-radius: 4px;
            }
            .diff-marker {
                font-weight: bold;
                margin-right: 8px;
                display: inline-block;
                width: 20px;
            }
            .diff-equal .diff-marker {
                color: #28a745;
            }
            .diff-delete .diff-marker {
                color: #dc3545;
            }
            .diff-insert .diff-marker {
                color: #28a745;
            }
            .diff-changed .diff-marker {
                color: #ffc107;
            }
            .line-content {
                flex: 1;
                white-space: pre-wrap;
            }
            .char-delete {
                background-color: #ffc1cc;
                text-decoration: line-through;
            }
            .char-insert {
                background-color: #acf2bd;
                font-weight: bold;
            }
            .diff-equal,
            .diff-delete,
            .diff-insert,
            .diff-changed {
                display: flex;
                align-items: flex-start;
            }
            .loading {
                display: none;
            }
            .spinner-border {
                width: 1rem;
                height: 1rem;
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    </head>
    <body>
        <div class="container mt-5">
            <h1 class="text-center mb-4">LLM Response Diff Tool</h1>

            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <form id="compareForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="prompt1" class="form-label"
                                        >Prompt 1</label
                                    >
                                    <textarea
                                        class="form-control"
                                        id="prompt1"
                                        name="prompt1"
                                        rows="4"
                                        placeholder="Enter your first prompt here..."
                                        required
                                    ></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="prompt2" class="form-label"
                                        >Prompt 2 (optional - same as Prompt 1
                                        if empty)</label
                                    >
                                    <textarea
                                        class="form-control"
                                        id="prompt2"
                                        name="prompt2"
                                        rows="4"
                                        placeholder="Enter your second prompt here..."
                                    ></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="model1" class="form-label"
                                        >Model 1</label
                                    >
                                    <select
                                        class="form-select"
                                        id="model1"
                                        name="model1"
                                        required
                                    >
                                        <optgroup label="OpenAI">
                                            <option value="openai:gpt-4o">GPT-4o</option>
                                            <option value="openai:gpt-4o-mini">GPT-4o Mini</option>
                                            <option value="openai:gpt-4-turbo">GPT-4 Turbo</option>
                                            <option value="openai:gpt-4">GPT-4</option>
                                            <option value="openai:gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                        </optgroup>
                                        <optgroup label="Anthropic">
                                            <option value="anthropic:claude-sonnet-4-5-20250929">Claude Sonnet 4.5</option>
                                            <option value="anthropic:claude-opus-4-1-20250805">Claude Opus 4.1</option>
                                            <option value="anthropic:claude-sonnet-4-20250514">Claude Sonnet 4</option>
                                            <option value="anthropic:claude-opus-4-20250514">Claude Opus 4</option>
                                            <option value="anthropic:claude-3-5-sonnet-20240620">Claude 3.5 Sonnet</option>
                                        </optgroup>
                                        <optgroup label="Google (Not yet implemented)" disabled>
                                            <option value="google:gemini-2.0-flash-exp" disabled>Gemini 2.0 Flash (Not yet implemented)</option>
                                            <option value="google:gemini-1.5-pro" disabled>Gemini 1.5 Pro (Not yet implemented)</option>
                                            <option value="google:gemini-1.5-flash" disabled>Gemini 1.5 Flash (Not yet implemented)</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="model2" class="form-label"
                                        >Model 2 (optional - same as Model 1 if
                                        empty)</label
                                    >
                                    <select
                                        class="form-select"
                                        id="model2"
                                        name="model2"
                                    >
                                        <option value="">Same as Model 1</option>
                                        <optgroup label="OpenAI">
                                            <option value="openai:gpt-4o">GPT-4o</option>
                                            <option value="openai:gpt-4o-mini">GPT-4o Mini</option>
                                            <option value="openai:gpt-4-turbo">GPT-4 Turbo</option>
                                            <option value="openai:gpt-4">GPT-4</option>
                                            <option value="openai:gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                        </optgroup>
                                        <optgroup label="Anthropic">
                                            <option value="anthropic:claude-sonnet-4-5-20250929">Claude Sonnet 4.5</option>
                                            <option value="anthropic:claude-opus-4-1-20250805">Claude Opus 4.1</option>
                                            <option value="anthropic:claude-sonnet-4-20250514">Claude Sonnet 4</option>
                                            <option value="anthropic:claude-opus-4-20250514">Claude Opus 4</option>
                                            <option value="anthropic:claude-3-5-sonnet-20240620">Claude 3.5 Sonnet</option>
                                        </optgroup>
                                        <optgroup label="Google (Not yet implemented)" disabled>
                                            <option value="google:gemini-2.0-flash-exp" disabled>Gemini 2.0 Flash (Not yet implemented)</option>
                                            <option value="google:gemini-1.5-pro" disabled>Gemini 1.5 Pro (Not yet implemented)</option>
                                            <option value="google:gemini-1.5-flash" disabled>Gemini 1.5 Flash (Not yet implemented)</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mb-4">
                            <button type="submit" class="btn btn-primary">
                                <span
                                    class="loading spinner-border spinner-border-sm me-2"
                                    role="status"
                                ></span>
                                Compare Responses
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="results" style="display: none">
                <hr />
                <h3>Results</h3>

                <div
                    id="similarityPanel"
                    class="card mb-4"
                    style="display: none"
                >
                    <div class="card-body">
                        <h5 class="card-title">Similarity Overview</h5>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">Similarity Score:</span>
                                    <div class="progress flex-grow-1 me-2" style="height: 25px;">
                                        <div id="similarityBar" class="progress-bar" role="progressbar" style="width: 0%">
                                            <span id="similarityScore">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-success">
                                    <span class="badge bg-success">Shared Concepts</span>
                                </h6>
                                <ul id="sharedConcepts" class="list-unstyled small"></ul>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-primary">
                                    <span class="badge bg-primary">Unique to Response 1</span>
                                </h6>
                                <ul id="uniqueToResponse1" class="list-unstyled small"></ul>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-warning">
                                    <span class="badge bg-warning text-dark">Unique to Response 2</span>
                                </h6>
                                <ul id="uniqueToResponse2" class="list-unstyled small"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    id="summaryPanel"
                    class="alert alert-info mb-4"
                    style="display: none"
                >
                    <h5 class="alert-heading">AI Summary</h5>
                    <p id="summaryText" class="mb-0"></p>
                </div>

                <div class="unified-scroll-container">
                    <div class="response-wrapper">
                        <div class="response-column">
                            <h5 id="model1Name" class="sticky-header"></h5>
                            <div id="response1" class="response-content"></div>
                        </div>
                        <div class="response-column">
                            <h5 id="model2Name" class="sticky-header"></h5>
                            <div id="response2" class="response-content"></div>
                        </div>
                    </div>
                </div>

                <h5>Visual Diff</h5>
                <div id="diffView" class="diff-container"></div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            document
                .getElementById("compareForm")
                .addEventListener("submit", async function (e) {
                    e.preventDefault();

                    const submitBtn = e.target.querySelector(
                        'button[type="submit"]',
                    );
                    const loading = submitBtn.querySelector(".loading");
                    const results = document.getElementById("results");

                    loading.style.display = "inline-block";
                    submitBtn.disabled = true;
                    results.style.display = "none";

                    const formData = new FormData(e.target);

                    try {
                        const response = await fetch("/compare", {
                            method: "POST",
                            body: formData,
                        });

                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! status: ${response.status}`,
                            );
                        }

                        const data = await response.json();

                        document.getElementById("model1Name").textContent =
                            `${data.model1} - Response`;
                        document.getElementById("model2Name").textContent =
                            `${data.model2} - Response`;

                        // Safely render markdown with DOMPurify sanitization
                        let response1Html = DOMPurify.sanitize(
                            marked.parse(data.response1),
                        );
                        let response2Html = DOMPurify.sanitize(
                            marked.parse(data.response2),
                        );

                        // Apply highlighting for shared concepts
                        if (
                            data.similarity_data &&
                            data.similarity_data.shared_concepts
                        ) {
                            data.similarity_data.shared_concepts.forEach(
                                (concept) => {
                                    // Case-insensitive highlighting
                                    const regex = new RegExp(
                                        `(${concept.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
                                        "gi",
                                    );
                                    response1Html = response1Html.replace(
                                        regex,
                                        '<mark class="highlight-shared">$1</mark>',
                                    );
                                    response2Html = response2Html.replace(
                                        regex,
                                        '<mark class="highlight-shared">$1</mark>',
                                    );
                                },
                            );
                        }

                        document.getElementById("response1").innerHTML =
                            response1Html;
                        document.getElementById("response2").innerHTML =
                            response2Html;
                        document.getElementById("diffView").innerHTML =
                            data.diff_html;

                        // Show similarity overview
                        if (data.similarity_data) {
                            const score = data.similarity_data.similarity_score;
                            document.getElementById("similarityScore").textContent =
                                score + "%";
                            document.getElementById("similarityBar").style.width =
                                score + "%";

                            // Color code the progress bar
                            const progressBar =
                                document.getElementById("similarityBar");
                            progressBar.classList.remove(
                                "bg-danger",
                                "bg-warning",
                                "bg-success",
                            );
                            if (score < 40) {
                                progressBar.classList.add("bg-danger");
                            } else if (score < 70) {
                                progressBar.classList.add("bg-warning");
                            } else {
                                progressBar.classList.add("bg-success");
                            }

                            // Populate shared concepts
                            const sharedList =
                                document.getElementById("sharedConcepts");
                            sharedList.innerHTML = "";
                            data.similarity_data.shared_concepts.forEach(
                                (concept) => {
                                    const li = document.createElement("li");
                                    li.textContent = "• " + concept;
                                    sharedList.appendChild(li);
                                },
                            );

                            // Populate unique to response 1
                            const unique1List = document.getElementById(
                                "uniqueToResponse1",
                            );
                            unique1List.innerHTML = "";
                            data.similarity_data.unique_to_response1.forEach(
                                (concept) => {
                                    const li = document.createElement("li");
                                    li.textContent = "• " + concept;
                                    unique1List.appendChild(li);
                                },
                            );

                            // Populate unique to response 2
                            const unique2List = document.getElementById(
                                "uniqueToResponse2",
                            );
                            unique2List.innerHTML = "";
                            data.similarity_data.unique_to_response2.forEach(
                                (concept) => {
                                    const li = document.createElement("li");
                                    li.textContent = "• " + concept;
                                    unique2List.appendChild(li);
                                },
                            );

                            document.getElementById(
                                "similarityPanel",
                            ).style.display = "block";
                        }

                        // Show AI summary
                        document.getElementById("summaryText").textContent =
                            data.summary;
                        document.getElementById("summaryPanel").style.display =
                            "block";

                        results.style.display = "block";
                    } catch (error) {
                        alert("Error: " + error.message);
                    } finally {
                        loading.style.display = "none";
                        submitBtn.disabled = false;
                    }
                });
        </script>
    </body>
</html>
